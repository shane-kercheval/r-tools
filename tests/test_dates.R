library('testthat')
source('../tools.R', chdir=TRUE)

#to run from command line, use:
#library('testthat')
#test_file("test_dates.R")

test_that("general: dates", {
	date_string = c('2015-12-31 XX:XX:XX', '2016-01-01 XX:XX:XX', '2016-01-03 XX:XX:XX', '2016-01-04 XX:XX:XX')
	df = data.frame(date_string, stringsAsFactors = FALSE)
	df$date = convert_to_date(vector_string_date = df$date_string)
	df = add_date_columns(df, 'date')
	expect_that(length(colnames(df)), equals(8))
	expect_true(any(colnames(df) == 'date_string'))
	expect_true(any(colnames(df) == 'date'))
	expect_true(any(colnames(df) == 'year'))
	expect_true(any(colnames(df) == 'month'))
	expect_true(any(colnames(df) == 'week'))
	expect_true(any(colnames(df) == 'weekday'))
	expect_true(any(colnames(df) == 'day_of_year'))
	expect_true(any(colnames(df) == 'day_of_month'))

	expect_that(df$year[df$date_string == '2015-12-31 XX:XX:XX'], equals(2015))
	expect_that(df$month[df$date_string == '2015-12-31 XX:XX:XX'], equals(12))
	expect_that(df$week[df$date_string == '2015-12-31 XX:XX:XX'], equals(52))
	expect_true(df$weekday[df$date_string == '2015-12-31 XX:XX:XX'] == 'Thursday')
	expect_that(df$day_of_year[df$date_string == '2015-12-31 XX:XX:XX'], equals(365))
	expect_that(df$day_of_month[df$date_string == '2015-12-31 XX:XX:XX'], equals(31))
	
	expect_that(df$year[df$date_string == '2016-01-01 XX:XX:XX'], equals(2016))
	expect_that(df$month[df$date_string == '2016-01-01 XX:XX:XX'], equals(1))
	expect_that(df$week[df$date_string == '2016-01-01 XX:XX:XX'], equals(0))
	expect_true(df$weekday[df$date_string == '2016-01-01 XX:XX:XX'] == 'Friday')
	expect_that(df$day_of_year[df$date_string == '2016-01-01 XX:XX:XX'], equals(1))
	expect_that(df$day_of_month[df$date_string == '2016-01-01 XX:XX:XX'], equals(1))

	expect_that(df$year[df$date_string == '2016-01-03 XX:XX:XX'], equals(2016))
	expect_that(df$month[df$date_string == '2016-01-03 XX:XX:XX'], equals(1))
	expect_that(df$week[df$date_string == '2016-01-03 XX:XX:XX'], equals(0))
	expect_true(df$weekday[df$date_string == '2016-01-03 XX:XX:XX'] == 'Sunday')
	expect_that(df$day_of_year[df$date_string == '2016-01-03 XX:XX:XX'], equals(3))
	expect_that(df$day_of_month[df$date_string == '2016-01-03 XX:XX:XX'], equals(3))

	expect_that(df$year[df$date_string == '2016-01-04 XX:XX:XX'], equals(2016))
	expect_that(df$month[df$date_string == '2016-01-04 XX:XX:XX'], equals(1))
	expect_that(df$week[df$date_string == '2016-01-04 XX:XX:XX'], equals(1))
	expect_true(df$weekday[df$date_string == '2016-01-04 XX:XX:XX'] == 'Monday')
	expect_that(df$day_of_year[df$date_string == '2016-01-04 XX:XX:XX'], equals(4))
	expect_that(df$day_of_month[df$date_string == '2016-01-04 XX:XX:XX'], equals(4))
	
	date_string = c('2015-12-31', '2016-01-01', '2016-01-03', '2016-01-04')
	df = data.frame(date_string, stringsAsFactors = FALSE)
	df$date = convert_to_date(df$date_string, has_time=FALSE)
	df = add_date_columns(df, 'date')
	expect_that(length(colnames(df)), equals(8))
	expect_true(any(colnames(df) == 'date_string'))
	expect_true(any(colnames(df) == 'date'))
	expect_true(any(colnames(df) == 'year'))
	expect_true(any(colnames(df) == 'month'))
	expect_true(any(colnames(df) == 'week'))
	expect_true(any(colnames(df) == 'weekday'))
	expect_true(any(colnames(df) == 'day_of_year'))
	expect_true(any(colnames(df) == 'day_of_month'))
	
	expect_that(df$year[df$date_string == '2015-12-31'], equals(2015))
	expect_that(df$month[df$date_string == '2015-12-31'], equals(12))
	expect_that(df$week[df$date_string == '2015-12-31'], equals(52))
	expect_true(df$weekday[df$date_string == '2015-12-31'] == 'Thursday')
	expect_that(df$day_of_year[df$date_string == '2015-12-31'], equals(365))
	expect_that(df$day_of_month[df$date_string == '2015-12-31'], equals(31))
	
	expect_that(df$year[df$date_string == '2016-01-01'], equals(2016))
	expect_that(df$month[df$date_string == '2016-01-01'], equals(1))
	expect_that(df$week[df$date_string == '2016-01-01'], equals(0))
	expect_true(df$weekday[df$date_string == '2016-01-01'] == 'Friday')
	expect_that(df$day_of_year[df$date_string == '2016-01-01'], equals(1))
	expect_that(df$day_of_month[df$date_string == '2016-01-01'], equals(1))
	
	expect_that(df$year[df$date_string == '2016-01-03'], equals(2016))
	expect_that(df$month[df$date_string == '2016-01-03'], equals(1))
	expect_that(df$week[df$date_string == '2016-01-03'], equals(0))
	expect_true(df$weekday[df$date_string == '2016-01-03'] == 'Sunday')
	expect_that(df$day_of_year[df$date_string == '2016-01-03'], equals(3))
	expect_that(df$day_of_month[df$date_string == '2016-01-03'], equals(3))
	
	expect_that(df$year[df$date_string == '2016-01-04'], equals(2016))
	expect_that(df$month[df$date_string == '2016-01-04'], equals(1))
	expect_that(df$week[df$date_string == '2016-01-04'], equals(1))
	expect_true(df$weekday[df$date_string == '2016-01-04'] == 'Monday')
	expect_that(df$day_of_year[df$date_string == '2016-01-04'], equals(4))
	expect_that(df$day_of_month[df$date_string == '2016-01-04'], equals(4))
})

test_that("general: string_to_date", {
	date_string = '2016-04-23'

	converted_date = string_to_date(date_string=date_string)
	year = as.numeric(format(converted_date, '%Y'))
	month = as.numeric(format(converted_date, '%m'))
	day = as.numeric(format(converted_date, '%d'))

	expect_that(year, equals(2016))
	expect_that(month, equals(4))
	expect_that(day, equals(23))
})

test_that("general: convert_to_date_time", {
	date_time_string_vector = c('2016-01-01 00:00:00', '2016-08-20 06:06:29', '2016-05-22 13:54:35')
	date_time_vector = convert_to_date_time(date_time_string_vector)
	
	expect_that(print_c(date_time_vector), equals("[1] \"2016-01-01 00:00:00 GMT\" \"2016-08-20 06:06:29 GMT\" \"2016-05-22 13:54:35 GMT\""))
})
